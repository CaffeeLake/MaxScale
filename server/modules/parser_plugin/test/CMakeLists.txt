add_executable(pp_compare pp_compare.cc testreader.cc)
target_link_libraries(pp_compare maxscale-common)

add_executable(pp_convert pp_convert.cc testreader.cc)
target_link_libraries(pp_convert maxscale-common)

add_executable(pp_concurrency pp_concurrency.cc)
target_link_libraries(pp_concurrency maxscale-common)

add_executable(pp_cache pp_cache.cc)
target_link_libraries(pp_cache maxscale-common)

add_executable(crash_pp_sqlite crash_pp_sqlite.cc)
target_link_libraries(crash_pp_sqlite maxscale-common)

add_executable(test_pp_sqlite test_pp_sqlite.cc)
target_link_libraries(test_pp_sqlite maxscale-common)

add_test(test_crash_pp_sqlite crash_pp_sqlite)
add_test(test_pp_sqlite test_pp_sqlite)

if (BUILD_PP_MYSQLEMBEDDED)

  add_test(test_pp_comparecreate pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/create.test)
  add_test(test_pp_comparedelete pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/delete.test)
  add_test(test_pp_compareinsert pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/insert.test)
  add_test(test_pp_comparejoin pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/join.test)
  add_test(test_pp_compareselect pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/select.test)
  add_test(test_pp_compareset pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/set.test)
  add_test(test_pp_compareupdate pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/update.test)
  add_test(test_pp_comparemaxscale pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/maxscale.test)
  add_test(test_pp_comparewhitespace pp_compare -v 2 -S -s "select user from mysql.user; ")

  add_test(test_pp_cte_simple       pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/cte_simple.test)
  add_test(test_pp_cte_grant        pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/cte_grant.test)
  add_test(test_pp_cte_nonrecursive pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/cte_nonrecursive.test)
  add_test(test_pp_cte_recursive    pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/cte_recursive.test)

  add_test(test_pp_win                  pp_compare -v2 ${CMAKE_CURRENT_SOURCE_DIR}/win.test)
  add_test(test_pp_win_avg              pp_compare -v2 ${CMAKE_CURRENT_SOURCE_DIR}/win_avg.test)
  add_test(test_pp_win_big-mdev-10092   pp_compare -v2 ${CMAKE_CURRENT_SOURCE_DIR}/win_big-mdev-10092.test)
  add_test(test_pp_win_big-mdev-11697   pp_compare -v2 ${CMAKE_CURRENT_SOURCE_DIR}/win_big-mdev-11697.test)
  add_test(test_pp_win_big              pp_compare -v2 ${CMAKE_CURRENT_SOURCE_DIR}/win_big.test)
  add_test(test_pp_win_bit              pp_compare -v2 ${CMAKE_CURRENT_SOURCE_DIR}/win_bit.test)
  add_test(test_pp_win_empty_over       pp_compare -v2 ${CMAKE_CURRENT_SOURCE_DIR}/win_empty_over.test)
  add_test(test_pp_win_first_last_value pp_compare -v2 ${CMAKE_CURRENT_SOURCE_DIR}/win_first_last_value.test)
  add_test(test_pp_win_i_s              pp_compare -v2 ${CMAKE_CURRENT_SOURCE_DIR}/win_i_s.test)
  add_test(test_pp_win_lead_lag         pp_compare -v2 ${CMAKE_CURRENT_SOURCE_DIR}/win_lead_lag.test)
  add_test(test_pp_win_min_max          pp_compare -v2 ${CMAKE_CURRENT_SOURCE_DIR}/win_min_max.test)
  add_test(test_pp_win_nth_value        pp_compare -v2 ${CMAKE_CURRENT_SOURCE_DIR}/win_nth_value.test)
  add_test(test_pp_win_ntile            pp_compare -v2 ${CMAKE_CURRENT_SOURCE_DIR}/win_ntile.test)
  add_test(test_pp_win_orderby          pp_compare -v2 ${CMAKE_CURRENT_SOURCE_DIR}/win_orderby.test)
  add_test(test_pp_win_percent_cume     pp_compare -v2 ${CMAKE_CURRENT_SOURCE_DIR}/win_percent_cume.test)
  add_test(test_pp_win_rank             pp_compare -v2 ${CMAKE_CURRENT_SOURCE_DIR}/win_rank.test)
  add_test(test_pp_win_std              pp_compare -v2 ${CMAKE_CURRENT_SOURCE_DIR}/win_std.test)
  add_test(test_pp_win_sum              pp_compare -v2 ${CMAKE_CURRENT_SOURCE_DIR}/win_sum.test)

  add_test(test_pp_oracle-binlog_stm_ps     pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/binlog_stm_ps.test)
  add_test(test_pp_oracle-binlog_stm_sp     pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/binlog_stm_sp.test)
  add_test(test_pp_oracle-exception         pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/exception.test)
  add_test(test_pp_oracle-func_case         pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/func_case.test)
  add_test(test_pp_oracle-func_concat       pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/func_concat.test)
  add_test(test_pp_oracle-func_decode       pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/func_decode.test)
  add_test(test_pp_oracle-func_length       pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/func_length.test)
  add_test(test_pp_oracle-func_misc         pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/func_misc.test)
  add_test(test_pp_oracle-misc              pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/misc.test)
  add_test(test_pp_oracle-ps                pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/ps.test)
  add_test(test_pp_oracle-sequence          pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/sequence.test)
  add_test(test_pp_oracle-sp-anonymous      pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/sp-anonymous.test)
  add_test(test_pp_oracle-sp-code           pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/sp-code.test)
  add_test(test_pp_oracle-sp-cursor-decl    pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/sp-cursor-decl.test)
  add_test(test_pp_oracle-sp-cursor-rowtype pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/sp-cursor-rowtype.test)
  add_test(test_pp_oracle-sp-cursor         pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/sp-cursor.test)
  add_test(test_pp_oracle-sp-goto           pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/sp-goto.test)
  add_test(test_pp_oracle-sp-param_inc      pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/sp-param.inc)
  add_test(test_pp_oracle-sp-param          pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/sp-param.test)
  add_test(test_pp_oracle-sp-row            pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/sp-row.test)
  add_test(test_pp_oracle-sp-row-vs-var_inc pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/sp-row-vs-var.inc)
  add_test(test_pp_oracle-sp-security       pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/sp-security.test)
  add_test(test_pp_oracle-sp                pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/sp.test)
  add_test(test_pp_oracle-trigger           pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/trigger.test)
  add_test(test_pp_oracle-truncate          pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/truncate.test)
  add_test(test_pp_oracle-type_blob         pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/type_blob.test)
  add_test(test_pp_oracle-type_clob         pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/type_clob.test)
  add_test(test_pp_oracle-type_date         pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/type_date.test)
  add_test(test_pp_oracle-type_number       pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/type_number.test)
  add_test(test_pp_oracle-type_raw          pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/type_raw.test)
  add_test(test_pp_oracle-type_varchar      pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/type_varchar.test)
  add_test(test_pp_oracle-type_varchar2     pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/type_varchar2.test)
  add_test(test_pp_oracle-type_variables    pp_compare -v 2 ${CMAKE_CURRENT_SOURCE_DIR}/oracle/variables.test)
endif()

if (BUILD_POSTGRES)
  target_link_libraries(compare postgresprotocol)
  target_compile_definitions(compare PRIVATE -DBUILD_POSTGRES=1)

  file(GLOB POSTGRES_TEST_FILES ${CMAKE_CURRENT_SOURCE_DIR}/postgres/*.sql)

  # From all files in the directory, pick statements that match the regex "^ALTER TABLE "
  # and check that the output for "operation" matches the regex "OP_ALTER_TABLE".
  add_test(pg_alter_table pp_compare -v 3 -0 pp_pg_query -E postgres -x "^ALTER TABLE " -p operation -c "ALTER_TABLE" ${POSTGRES_TEST_FILES})
  add_test(pg_alter pp_compare -v 3 -0 pp_pg_query -E postgres -x "^ALTER" -p operation -c "ALTER" ${POSTGRES_TEST_FILES})

  add_test(pg_create_table pp_compare -v 3 -0 pp_pg_query -E postgres -x "^CREATE TABLE " -p operation -c "CREATE_TABLE" ${POSTGRES_TEST_FILES})
  add_test(pg_create pp_compare -v 3 -0 pp_pg_query -E postgres -x "^CREATE" -p operation -c "CREATE" ${POSTGRES_TEST_FILES})

  add_test(pg_drop_table pp_compare -v 3 -0 pp_pg_query -E postgres -x "^DROP TABLE " -p operation -c "DROP_TABLE" ${POSTGRES_TEST_FILES})
  add_test(pg_drop pp_compare -v 3 -0 pp_pg_query -E postgres -x "^DROP" -p operation -c "DROP" ${POSTGRES_TEST_FILES})

endif()
